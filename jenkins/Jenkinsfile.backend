pipeline {
    agent any
    
    triggers {
        GenericTrigger(
            genericVariables: [
                // [ìˆ˜ì •] Workflow Run ì´ë²¤íŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ
                [key: 'BRANCH', value: '$.workflow_run.head_branch'],
                [key: 'STATUS', value: '$.action'],
                [key: 'RESULT', value: '$.workflow_run.conclusion']
            ],
            
            causeString: 'Triggered by GitHub Actions Completion (Backend)',
            token: 'backend-deploy-token', // ë°±ì—”ë“œ í† í° í™•ì¸!
            
            printContributedVariables: true,
            printPostContent: true,
            
            regexpFilterText: '$BRANCH $STATUS $RESULT',
            
            // [í•„í„°] dev ë¸Œëœì¹˜ + ì™„ë£Œë¨ + ì„±ê³µí•¨ (ë°±ì—”ë“œ í•µì‹¬ ë¡œì§)
            regexpFilterExpression: 'dev completed success'
        )
    }
    
    environment {
        AWS_REGION = 'ap-northeast-2'
        ECS_CLUSTER = 'ruokat-cluster'
        ECS_SERVICE = 'ruokat-backend-service' // ë°±ì—”ë“œ ì„œë¹„ìŠ¤ í™•ì¸!
    }
    
    stages {
        // [ì¶”ê°€ëœ ë¶€ë¶„] ë¹Œë“œ ì •ë³´ í‘œì‹œ ë‹¨ê³„ âœ¨
        stage('Init & Build Info') {
            steps {
                script {
                    // 1. ë¡œê·¸ ì¶œë ¥
                    echo "ğŸš€ Triggered by Branch: ${BRANCH}"
                    
                    // 2. ì  í‚¨ìŠ¤ ë¹Œë“œ ì´ë¦„ ë³€ê²½ (ì˜ˆ: #15 - dev)
                    currentBuild.displayName = "#${BUILD_NUMBER} - ${BRANCH}"
                    
                    // 3. ì„¤ëª… ì¶”ê°€
                    currentBuild.description = "Status: ${STATUS} / Result: ${RESULT}"
                }
            }
        }

        stage('Verify AWS Identity') {
            steps {
                sh "aws sts get-caller-identity"
            }
        }
        
        stage('Deploy to ECS') {
            steps {
                script {
                    echo "ğŸš€ Deploying ${ECS_SERVICE} to ${ECS_CLUSTER}..."
                    
                    // ECS ì„œë¹„ìŠ¤ ê°•ì œ ì¬ë°°í¬
                    sh """
                        aws ecs update-service \
                            --cluster ${ECS_CLUSTER} \
                            --service ${ECS_SERVICE} \
                            --force-new-deployment \
                            --region ${AWS_REGION}
                    """
                    
                    echo "ğŸ“‹ Deployment triggered. Check ECS console for status."
                    echo "âœ… Backend deployment triggered successfully!"
                }
            }
        }
    }
    
    post {
        failure {
            echo "âŒ Backend deployment failed!"
        }
    }
}
