pipeline {
    agent any
    
    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'ref', value: '$.ref']
            ],
            causeString: 'Triggered by GitHub Push',
            token: 'backend-deploy-token',
            printContributedVariables: true,
            printPostContent: true,
            regexpFilterText: '$ref',
            regexpFilterExpression: 'refs/heads/dev'  // dev ë¸Œëœì¹˜ë§Œ ê°ì§€
            // regexpFilterExpression: 'refs/heads/main'  // main ë¸Œëœì¹˜ (ì£¼ì„ ì²˜ë¦¬)
        )
    }
    
    environment {
        AWS_REGION = 'ap-northeast-2'
        ECS_CLUSTER = 'ruokat-cluster'
        ECS_SERVICE = 'ruokat-backend-service'
    }
    stages {
        stage('Verify AWS Identity') {
            steps {
                sh "aws sts get-caller-identity"
            }
        }
        stage('Deploy to ECS') {
            steps {
                script {
                    echo "ğŸš€ Deploying ${ECS_SERVICE} to ${ECS_CLUSTER}..."
                    
                    // ECS ì„œë¹„ìŠ¤ ê°•ì œ ì¬ë°°í¬
                    sh """
                        aws ecs update-service \
                            --cluster ${ECS_CLUSTER} \
                            --service ${ECS_SERVICE} \
                            --force-new-deployment \
                            --region ${AWS_REGION}
                    """
                    
                    // ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ (ì•ˆì •í™” ëŒ€ê¸°ëŠ” ìƒëµ - ì‹œê°„ ì˜¤ë˜ ê±¸ë¦¼)
                    echo "ğŸ“‹ Deployment triggered. Check ECS console for status."
                    
                    echo "âœ… Backend deployment triggered successfully!"
                }
            }
        }
    }
    post {
        failure {
            echo "âŒ Backend deployment failed!"
        }
    }
}
