pipeline {
    agent any
    
    triggers {
        GenericTrigger(
            genericVariables: [
                // [ìˆ˜ì •] ê¸°ì¡´ 'ref' ì‚­ì œ -> 'workflow_run' ë‚´ë¶€ì˜ ë¸Œëœì¹˜ëª… ê°€ì ¸ì˜¤ê¸°
                // ë°±ì—”ë“œëŠ” 'dev' ë¸Œëœì¹˜ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ 'dev'ê°€ ë“¤ì–´ì™€ì•¼ í•©ë‹ˆë‹¤.
                [key: 'BRANCH', value: '$.workflow_run.head_branch'],

                // [ì¶”ê°€] ìƒíƒœ í™•ì¸ (ì‹œì‘ë¨/ì™„ë£Œë¨)
                [key: 'STATUS', value: '$.action'],

                // [ì¶”ê°€] ê²°ê³¼ í™•ì¸ (ì„±ê³µ/ì‹¤íŒ¨)
                [key: 'RESULT', value: '$.workflow_run.conclusion']
            ],
            
            // [ìˆ˜ì •] íŠ¸ë¦¬ê±° ì›ì¸ ì„¤ëª… ë³€ê²½
            causeString: 'Triggered by GitHub Actions Completion (Backend)',
            
            // [í™•ì¸] ë°±ì—”ë“œìš© í† í° ìœ ì§€
            token: 'backend-deploy-token',
            
            printContributedVariables: true,
            printPostContent: true,
            
            // [ìˆ˜ì •] í•„í„°ë§ ëŒ€ìƒ ë³€ìˆ˜ ë³€ê²½
            regexpFilterText: '$BRANCH $STATUS $RESULT',
            
            // [ìˆ˜ì •] í•„í„°ë§ ì¡°ê±´ ë³€ê²½ (ë°±ì—”ë“œ í•µì‹¬!)
            // í•´ì„: ë¸Œëœì¹˜ëŠ” 'dev' + ìƒíƒœëŠ” 'completed(ì™„ë£Œ)' + ê²°ê³¼ëŠ” 'success(ì„±ê³µ)'
            regexpFilterExpression: 'dev completed success'
        )
    }
    
    environment {
        AWS_REGION = 'ap-northeast-2'
        ECS_CLUSTER = 'ruokat-cluster'
        ECS_SERVICE = 'ruokat-backend-service'
    }
    stages {
        stage('Verify AWS Identity') {
            steps {
                sh "aws sts get-caller-identity"
            }
        }
        stage('Deploy to ECS') {
            steps {
                script {
                    echo "ğŸš€ Deploying ${ECS_SERVICE} to ${ECS_CLUSTER}..."
                    
                    // ECS ì„œë¹„ìŠ¤ ê°•ì œ ì¬ë°°í¬ (ê¸°ì¡´ ìœ ì§€)
                    // --force-new-deployment ì˜µì…˜ í•„ìˆ˜!
                    sh """
                        aws ecs update-service \
                            --cluster ${ECS_CLUSTER} \
                            --service ${ECS_SERVICE} \
                            --force-new-deployment \
                            --region ${AWS_REGION}
                    """
                    
                    echo "ğŸ“‹ Deployment triggered. Check ECS console for status."
                    echo "âœ… Backend deployment triggered successfully!"
                }
            }
        }
    }
    post {
        failure {
            echo "âŒ Backend deployment failed!"
        }
    }
}
